# üöÄ –ú–ò–ì–†–ê–¶–ò–Ø –ù–ê –ï–î–ò–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï –§–ê–ô–õ–û–í

## ‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û:

### 1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `is_placeholder` –¥–ª—è –∑–∞–≥–ª—É—à–µ–∫
- ‚úÖ –°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ñ–∞–π–ª—ã
- ‚úÖ VIEW –¥–ª—è shared files –∏ orphaned files

### 2. **Backend:**
- ‚úÖ Multer –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤ `/content/` –≤–º–µ—Å—Ç–æ `/content/{device}/`
- ‚úÖ Endpoint `/api/files/resolve/:device/:file` –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
- ‚úÖ **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ:** –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ (INSERT –≤ –ë–î, ~1ms)
- ‚úÖ **–£–¥–∞–ª–µ–Ω–∏–µ:** —É–º–Ω–æ–µ (–ø–æ–¥—Å—á–µ—Ç —Å—Å—ã–ª–æ–∫, —É–¥–∞–ª–µ–Ω–∏–µ –µ—Å–ª–∏ 0)
- ‚úÖ **–ó–∞–≥–ª—É—à–∫–∏:** —á–µ—Ä–µ–∑ –ë–î —Ñ–ª–∞–≥ (–±–µ–∑ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤)

### 3. **Nginx:**
- ‚úÖ Proxy `/content/{device}/{file}` ‚Üí Node.js resolver
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Range requests –¥–ª—è seek

### 4. **–ö–ª–∏–µ–Ω—Ç—ã:**
- ‚úÖ **–ù–ï –¢–†–ï–ë–£–Æ–¢ –ò–ó–ú–ï–ù–ï–ù–ò–ô!** –í—Å—ë –ø—Ä–æ–∑—Ä–∞—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üìã –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ú–ò–ì–†–ê–¶–ò–ò:

### **–®–∞–≥ 1: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä**
```bash
sudo systemctl restart videocontrol
```

### **–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
sudo systemctl status videocontrol

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
sudo journalctl -u videocontrol -f
```

### **–®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Ñ–∞–π–ª–æ–≤**
```bash
cd /vid/videocontrol
sudo ./scripts/migrate-to-single-storage.sh
```

–°–∫—Ä–∏–ø—Ç:
- –ü–µ—Ä–µ–Ω–µ—Å–µ—Ç —Ñ–∞–π–ª—ã –∏–∑ `/content/{device}/` –≤ `/content/`
- –û–±–Ω–æ–≤–∏—Ç `file_path` –≤ –ë–î
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç `is_placeholder` –¥–ª—è —Ñ–∞–π–ª–æ–≤ `default.*`
- –£–¥–∞–ª–∏—Ç –ø—É—Å—Ç—ã–µ –ø–∞–ø–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### **–®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Nginx**
```bash
sudo nginx -t  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo systemctl reload nginx
```

### **–®–∞–≥ 5: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Å–Ω–æ–≤–∞**
```bash
sudo systemctl restart videocontrol
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:

### **1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞:**
- –û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –Ω–∞ –ª—é–±–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ñ–∞–π–ª –ø–æ—è–≤–∏–ª—Å—è –≤ `/content/` (–Ω–µ –≤ –ø–æ–¥–ø–∞–ø–∫–µ!)

### **2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º!):**
- –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å –æ–¥–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ
- –î–æ–ª–∂–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –∑–∞ <1 —Å–µ–∫—É–Ω–¥—É
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: "instant: true"

### **3. –£–¥–∞–ª–µ–Ω–∏–µ (—É–º–Ω–æ–µ):**
- –£–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª –Ω–∞ –æ–¥–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
- –§–∞–π–ª –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è –Ω–∞ –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: "Physical file kept (still used)"
- –£–¥–∞–ª–∏—Ç–µ –Ω–∞ –≤—Å–µ—Ö ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ: "Physical file deleted (no references)"

### **4. –ó–∞–≥–ª—É—à–∫–∞:**
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª –∫–∞–∫ –∑–∞–≥–ª—É—à–∫—É
- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- –ü–ª–µ–µ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–≥–ª—É—à–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î: `SELECT * FROM files_metadata WHERE is_placeholder=1;`

---

## üìä –ü–†–û–í–ï–†–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø:

```bash
# –°–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ?
sqlite3 config/main.db "SELECT * FROM shared_files;"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
sqlite3 config/main.db "SELECT * FROM device_storage_stats;"

# –ö–∞–∫–∏–µ –∑–∞–≥–ª—É—à–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã?
sqlite3 config/main.db "SELECT device_id, safe_name FROM files_metadata WHERE is_placeholder=1;"

# Orphaned files (–±–µ–∑ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤)
sqlite3 config/main.db "SELECT * FROM orphaned_files;"
```

---

## ‚ö° –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:

- ‚úÖ **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ** (<1ms –≤–º–µ—Å—Ç–æ –º–∏–Ω—É—Ç)
- ‚úÖ **–ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ event loop**
- ‚úÖ **–≠–∫–æ–Ω–æ–º–∏—è –¥–∏—Å–∫–∞** (–¥—É–±–ª–∏–∫–∞—Ç—ã –Ω–µ –∑–∞–Ω–∏–º–∞—é—Ç –º–µ—Å—Ç–æ)
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è**
- ‚úÖ **–£–º–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ** (—Ñ–∞–π–ª —É–¥–∞–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω–∏–∫—Ç–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç)
- ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** (—Å—Ç–∞—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

---

## üîß –û–¢–ö–ê–¢ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):

```bash
# –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é
git checkout HEAD~3 -- src/routes/files.js src/routes/placeholder.js src/middleware/multer-config.js nginx/

# –£–¥–∞–ª–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∏–∑ –ë–î
sqlite3 config/main.db "ALTER TABLE files_metadata DROP COLUMN is_placeholder;"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
sudo systemctl restart videocontrol
sudo systemctl reload nginx
```

