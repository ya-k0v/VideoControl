# –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –ø–ª–µ–µ—Ä–µ

## üéØ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ü–ª–µ–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `default.mp4`
2. **–ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –∫–∞—Ä—Ç–∏–Ω–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Ñ–æ–Ω–µ
3. **–ö–∞—Ä—Ç–∏–Ω–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** ‚Üí –≤ –∫—ç—à–µ –±—Ä–∞—É–∑–µ—Ä–∞
4. **–í–∏–¥–µ–æ –≥—Ä—É–∑—è—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é** ‚Üí –æ—Ç Nginx (–¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã Range requests)

## üì¶ –ß—Ç–æ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
- ‚úÖ –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (png, jpg, jpeg, gif, webp)
- ‚úÖ –ó–∞–≥–ª—É—à–∫–∞ `default.*` (–æ—Ç–¥–µ–ª—å–Ω—ã–π –∫—ç—à)
- ‚úÖ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã (HTML, CSS, JS)

**–ù–ï –∫—ç—à–∏—Ä—É–µ—Ç—Å—è (–≥—Ä—É–∑—è—Ç—Å—è –æ—Ç Nginx):**
- ‚ùå –í–∏–¥–µ–æ (mp4, webm, ogg, mkv, mov, avi) - –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã Range requests
- ‚ùå PDF/PPTX (—Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ API –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏)

## ‚ö†Ô∏è –ü–æ—á–µ–º—É –≤–∏–¥–µ–æ –Ω–µ –∫—ç—à–∏—Ä—É–µ—Ç—Å—è?

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë—Ä–∞—É–∑–µ—Ä –¥–µ–ª–∞–µ—Ç Range requests –¥–ª—è seek –≤ –≤–∏–¥–µ–æ (`Range: bytes=1000-2000`)
**Service Worker –Ω–µ –º–æ–∂–µ—Ç** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å Range requests –∏–∑ –∫—ç—à–∞
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 100500 –º–µ–ª–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ KB, –≤–∏–¥–µ–æ —Ç–æ—Ä–º–æ–∑–∏—Ç

**–†–µ—à–µ–Ω–∏–µ:** –í–∏–¥–µ–æ –∏–¥—É—Ç –Ω–∞–ø—Ä—è–º—É—é –∫ Nginx, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç Range requests
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û–¥–∏–Ω –ø–æ—Ç–æ–∫, –ø–ª–∞–≤–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, —Ä–∞–±–æ—Ç–∞–µ—Ç seek

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –Ω–∞ –ø–ª–µ–µ—Ä–µ:

```
[Player] üì¶ –ó–∞–ø—É—Å–∫ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...
[Player] üì¶ –ù–∞–π–¥–µ–Ω–æ 5 —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏
[SW] Precaching 5 content files...
[SW] Cached: /content/pc001/video1.mp4 (45.2MB)
[SW] Cached: /content/pc001/video2.mp4 (123.5MB)
[SW] Already cached: /content/pc001/image.jpg
[SW] File too large, skipping: /content/pc001/huge.mp4 (750.0MB)
[SW] Precaching complete: 4 cached, 1 skipped
[Player] ‚úÖ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: 4 –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω–æ, 1 –ø—Ä–æ–ø—É—â–µ–Ω–æ –∏–∑ 5
```

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏

–ò–∑–º–µ–Ω–∏—Ç–µ –≤ `/vid/videocontrol/public/sw.js`:

```javascript
// –õ–∏–º–∏—Ç—ã –∫—ç—à–∞
const MAX_CONTENT_ITEMS = 100;    // –ú–∞–∫—Å–∏–º—É–º —Ñ–∞–π–ª–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100)
const MAX_PRECACHE_FILE_SIZE = 500 * 1024 * 1024; // –ú–∞–∫—Å–∏–º—É–º 500MB
```

–í `/vid/videocontrol/public/js/player.js`:

```javascript
setTimeout(() => {
  precacheDeviceContent();
}, 3000); // –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3 —Å–µ–∫)
```

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞

–î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –ø–ª–µ–µ—Ä–µ:

```javascript
// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫—ç—à–∞
const channel = new MessageChannel();
channel.port1.onmessage = (e) => {
  console.log('–ö—ç—à:', e.data.count, '—Ñ–∞–π–ª–æ–≤');
  console.log('–†–∞–∑–º–µ—Ä:', (e.data.size/1024/1024).toFixed(1), 'MB');
  console.log('–§–∞–π–ª—ã:', e.data.urls);
};
navigator.serviceWorker.controller.postMessage(
  { type: 'GET_CACHE_STATS' },
  [channel.port2]
);
```

## üßπ –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞

**–í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å:**
```javascript
navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHE' });
```

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
- –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–µ—Ä—Å–∏–∏ Service Worker (v3 ‚Üí v4)
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ (—É–¥–∞–ª—è—é—Ç—Å—è —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã)

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

**1. –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥:**
```bash
cd /vid/videocontrol
git pull
sudo systemctl restart videocontrol
```

**2. –û–±–Ω–æ–≤–∏—Ç–µ –ø–ª–µ–µ—Ä:**
- –û—Ç–∫—Ä–æ–π—Ç–µ –ø–ª–µ–µ—Ä –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- –ù–∞–∂–º–∏—Ç–µ `Ctrl+Shift+R` (hard refresh)
- Service Worker v3 –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
- –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)
- –ß–µ—Ä–µ–∑ 3 —Å–µ–∫ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–µ
- –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å —Å–ø–∏–∫–µ—Ä–∞
- –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –Ω–∞—á–∞—Ç—å—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–ö–∞—Ä—Ç–∏–Ω–∫–∏:**
- ‚úÖ –ö—ç—à–∏—Ä—É—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞
- ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç –æ—Ñ–ª–∞–π–Ω

**–í–∏–¥–µ–æ:**
- ‚úÖ –ì—Ä—É–∑—è—Ç—Å—è –æ—Ç Nginx (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è 1 –ì–±–∏—Ç)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ Range requests –¥–ª—è seek
- ‚úÖ –û–¥–∏–Ω –ø–æ—Ç–æ–∫, 100-125 MB/s –Ω–∞ –≥–∏–≥–∞–±–∏—Ç–Ω–æ–π —Å–µ—Ç–∏
- ‚ÑπÔ∏è –ù–ï –∫—ç—à–∏—Ä—É—é—Ç—Å—è (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Range requests)

## üíæ –•—Ä–∞–Ω–∏–ª–∏—â–µ –±—Ä–∞—É–∑–µ—Ä–∞

**–õ–∏–º–∏—Ç—ã:**
- Chrome: ~60% —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –¥–∏—Å–∫–∞
- Firefox: ~50% —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –¥–∏—Å–∫–∞
- Edge: ~60% —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –¥–∏—Å–∫–∞

**–ü—Ä–∏–º–µ—Ä:**
- –î–∏—Å–∫ 100GB —Å–≤–æ–±–æ–¥–Ω–æ
- –ú–æ–∂–Ω–æ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞—Ç—å ~50GB –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –≠—Ç–æ ~100 –≤–∏–¥–µ–æ –ø–æ 500MB

## üîß Troubleshooting

**–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å - –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Service Worker –∞–∫—Ç–∏–≤–µ–Ω: `navigator.serviceWorker.controller`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ device_id –ø–µ—Ä–µ–¥–∞–Ω –≤ URL
4. Preview mode –æ—Ç–∫–ª—é—á–∞–µ—Ç –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫—É (`preview=1`)

**–§–∞–π–ª—ã –Ω–µ –∫—ç—à–∏—Ä—É—é—Ç—Å—è:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ (<500MB)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Service Worker v3 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
4. –û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –∫—ç—à –≤—Ä—É—á–Ω—É—é

**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∏–¥–µ—Ç –≤ —Ñ–æ–Ω–µ –∏ –ù–ï —Ç–æ—Ä–º–æ–∑–∏—Ç –ø–ª–µ–µ—Ä
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π I/O
- –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- –ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

## üéì –ö–∞–∫ —ç—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

**–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:**
1. **Service Worker API** - –ø–µ—Ä–µ—Ö–≤–∞—Ç —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
2. **Cache API** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. **MessageChannel** - —Å–≤—è–∑—å –ø–ª–µ–µ—Ä–∞ –∏ SW
4. **Fetch API** - –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. Player.js –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤: `GET /api/devices/:id/files`
2. –§–∏–ª—å—Ç—Ä—É–µ—Ç –º–µ–¥–∏–∞ —Ñ–∞–π–ª—ã (–≤–∏–¥–µ–æ, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ URL –≤ Service Worker —á–µ—Ä–µ–∑ `postMessage`
4. SW –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª —á–µ—Ä–µ–∑ `fetch()`
5. SW —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `caches.open(CONTENT_CACHE_NAME)`
6. –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ñ–∞–π–ª–∞ SW –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑ –∫—ç—à–∞ (`cache-first`)

**–ö–æ–¥:**
- Service Worker: `/vid/videocontrol/public/sw.js`
- –ü–ª–µ–µ—Ä: `/vid/videocontrol/public/js/player.js`
- API: `/vid/videocontrol/server.js` (endpoint `/api/devices/:id/files`)

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚ö° **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ** - —Ñ–∞–π–ª—ã —É–∂–µ –Ω–∞ –¥–∏—Å–∫–µ
- üì° **–≠–∫–æ–Ω–æ–º–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞** - –∑–∞–≥—Ä—É–∑–∫–∞ 1 —Ä–∞–∑
- üîí **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ —Å–±–æ—è—Ö —Å–µ—Ç–∏
- üéØ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- üßπ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤

