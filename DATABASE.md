# Архитектура базы данных VideoControl

## Общие сведения

VideoControl использует **единую SQLite базу данных** (`config/main.db`) для хранения всех данных системы.

### Преимущества SQLite:
- ✅ Отсутствие зависимостей (встроенная БД)
- ✅ ACID транзакции
- ✅ WAL mode для параллельных операций
- ✅ Быстродействие и надежность
- ✅ Простота резервного копирования (один файл)

## Структура базы данных

### 1. Аутентификация и безопасность

#### `users` - Пользователи системы
- `id` - Уникальный идентификатор
- `username` - Логин (уникальный)
- `full_name` - ФИО пользователя
- `password_hash` - Bcrypt хеш пароля
- `role` - Роль: `admin` или `speaker`
- `is_active` - Активность аккаунта
- `last_login` - Последний вход
- `created_at`, `updated_at` - Timestamps

**По умолчанию:**
- Логин: `admin`
- Пароль: `admin123`
- ⚠️ **ОБЯЗАТЕЛЬНО СМЕНИТЕ ПАРОЛЬ ПОСЛЕ УСТАНОВКИ!**

#### `refresh_tokens` - JWT refresh tokens
- Хранение refresh токенов для автоматического обновления сессий
- Автоматическая очистка истекших токенов

#### `audit_log` - Журнал аудита
- Логирование всех критических действий
- Хранение информации о пользователе, действии, IP, user-agent
- Используется для безопасности и отладки

### 2. Управление файлами

#### `files_metadata` - Метаданные медиафайлов
Хранит информацию о **видео, аудио и изображениях** для оптимизации и дедупликации:

- `device_id` - Устройство-владелец
- `safe_name` - Безопасное имя файла
- `original_name` - Оригинальное имя
- `file_path` - Физический путь к файлу
- `file_size` - Размер в байтах
- `md5_hash` - MD5 хеш (полный)
- `partial_md5` - MD5 первых 10MB (для быстрой проверки больших файлов)
- `video_width`, `video_height`, `video_duration` - Параметры видео
- `video_codec`, `video_bitrate` - Кодеки
- `audio_codec`, `audio_bitrate`, `audio_channels` - Аудио
- `is_placeholder` - Флаг заглушки устройства
- `file_mtime` - Время изменения файла

**Важно:** PDF, PPTX и папки с изображениями **НЕ хранятся** в этой таблице!

#### `file_names` - Маппинг имен файлов
Сопоставление безопасных имен файлов с оригинальными (кириллица, спецсимволы).

#### `file_statuses` - Статусы обработки файлов
Отслеживание состояния оптимизации видео:
- `pending` - В очереди
- `processing` - Обрабатывается
- `optimized` - Готов
- `error` - Ошибка

### 3. Устройства

#### `devices` - Устройства воспроизведения
- `device_id` - Уникальный ID (PK)
- `name` - Человекочитаемое имя
- `folder` - Папка устройства (ATV001, br001 и т.д.)
- `device_type` - Тип: `android`, `browser`, `mpv`
- `platform` - Платформа
- `capabilities` - JSON с возможностями
- `last_seen` - Последнее подключение
- `current_state` - Текущее состояние (JSON)

#### `placeholders` - Заглушки устройств
- `device_id` - Устройство
- `placeholder_file` - Файл заглушки
- `placeholder_type` - Тип: `video` или `image`

### 4. Системные настройки

#### `settings` - Ключ-значение настройки
- `schema_version` - Версия схемы БД
- `initialized_at` - Дата инициализации
- `single_storage_enabled` - Флаг единого хранилища

## Архитектура хранения файлов

### Единое хранилище (`/content/`)

**Для дедупликации (хранятся в `/content/`):**
- ✅ Видео: `.mp4`, `.webm`, `.ogg`, `.mkv`, `.mov`, `.avi`
- ✅ Аудио: `.mp3`, `.wav`, `.m4a`
- ✅ Одиночные изображения: `.png`, `.jpg`, `.jpeg`, `.gif`, `.webp`

**Для устройств (хранятся в `/content/{device}/`):**
- ✅ PDF документы → конвертируются в папку с изображениями
- ✅ PPTX презентации → конвертируются в папку с изображениями
- ✅ ZIP архивы → распаковываются в папку с изображениями
- ✅ Папки с изображениями (загруженные напрямую)

### Дедупликация файлов

При загрузке файла:
1. Вычисляется MD5 хеш (полный для файлов < 100MB, частичный для больших)
2. Проверяется наличие дубликата в БД
3. Если дубликат найден:
   - Файл **НЕ загружается** повторно
   - Создается только **запись в БД** со ссылкой на существующий файл
   - Экономия сетевого трафика и дискового пространства

### Views (представления)

#### `file_duplicates`
Показывает файлы с одинаковым MD5 на разных устройствах.

#### `shared_files`
Файлы, используемые несколькими устройствами одновременно. Показывает экономию места.

#### `device_storage_stats`
Статистика по каждому устройству: количество файлов, размер, последняя загрузка.

## Индексы и производительность

### Оптимизация запросов:
- `idx_files_device` - Быстрый поиск файлов устройства
- `idx_files_md5` - Дедупликация по полному MD5
- `idx_files_partial_md5` - Дедупликация по частичному MD5
- `idx_files_dedup` - Комбинированный индекс (MD5 + размер)
- `idx_files_path` - Подсчет ссылок на файл
- `idx_files_placeholder` - Поиск заглушки устройства

### WAL Mode
```sql
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;
PRAGMA cache_size = -64000;  -- 64MB cache
PRAGMA mmap_size = 30000000000;  -- 30GB mmap
```

## Инициализация БД

При первой установке выполняется скрипт `src/database/init.sql`, который:
1. Создает все таблицы
2. Создает индексы
3. Создает представления (views)
4. Создает триггеры (auto-update timestamps)
5. Создает дефолтного админа (`admin/admin123`)
6. Устанавливает начальные настройки

## Резервное копирование

### Простое копирование файла:
```bash
cp config/main.db config/main.db.backup
```

### Экспорт в SQL:
```bash
sqlite3 config/main.db .dump > backup.sql
```

### Восстановление:
```bash
sqlite3 config/main.db < backup.sql
```

## Миграции

**Миграций больше нет!** Вся схема БД находится в едином файле `src/database/init.sql`.

При необходимости изменения схемы:
1. Обновите `init.sql`
2. Увеличьте `schema_version` в настройках
3. Добавьте логику проверки версии при запуске (если нужно)

## Мониторинг

### Размер БД:
```bash
ls -lh config/main.db
```

### Статистика таблиц:
```sql
SELECT 
  name,
  (SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name=m.name) as tables,
  (SELECT COUNT(*) FROM main.users) as users,
  (SELECT COUNT(*) FROM main.devices) as devices,
  (SELECT COUNT(*) FROM main.files_metadata) as files
FROM sqlite_master m WHERE type='table' LIMIT 1;
```

### Статистика хранилища:
```sql
SELECT * FROM shared_files;
SELECT * FROM device_storage_stats;
```

## Безопасность

1. **Пароли** хешируются с bcrypt (cost=10)
2. **JWT токены** с коротким временем жизни (12h)
3. **Refresh tokens** хранятся в БД с IP и user-agent
4. **Audit log** записывает все критические действия
5. **SQL Injection** защита через prepared statements
6. **Права доступа**: `644` для БД, `755` для директорий

---

**Версия документа:** 1.0  
**Дата создания:** 2025-11-12  
**Версия схемы БД:** 2

